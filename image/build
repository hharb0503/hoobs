#!/usr/bin/env node

/**************************************************************************************************
 * hoobs-image                                                                                    *
 * Copyright (C) 2020 HOOBS                                                                       *
 *                                                                                                *
 * This program is free software: you can redistribute it and/or modify                           *
 * it under the terms of the GNU General Public License as published by                           *
 * the Free Software Foundation, either version 3 of the License, or                              *
 * (at your option) any later version.                                                            *
 *                                                                                                *
 * This program is distributed in the hope that it will be useful,                                *
 * but WITHOUT ANY WARRANTY; without even the implied warranty of                                 *
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                                  *
 * GNU General Public License for more details.                                                   *
 *                                                                                                *
 * You should have received a copy of the GNU General Public License                              *
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.                          *
 **************************************************************************************************/

const OS = require("os");
const Semver = require("semver");
const Program = require("commander");
const Inquirer = require("inquirer");
const { join } = require("path");
const { execSync } = require("child_process");

const {
    existsSync,
    readFileSync,
    writeFileSync,
    unlinkSync,
    mkdirSync,
    rmSync,
} = require("fs");

const root = join(__dirname, "../");
const pjson = JSON.parse(readFileSync(join(root, "package.json")).toString());

const prompt = Inquirer.createPromptModule();
const user = OS.userInfo();

function execTrySync(command, options) {
    try {
        return execSync(command, options);
    } catch (_error) {
        return undefined;
    }
}

Program.version(pjson.version, "-v, --version", "output the current version")
    .allowUnknownOption();

    Program.command("package")
    .description("build hoobs image")
    .action(() => {
        let proceed = true;

        const signing = execTrySync("command -v dpkg-sig").toString().replace(/\n/g, "").trim();

        if (!signing || signing === "") {
            console.log("dpkg-sig is not installed");
            proceed = false;
        }

        if (!existsSync(join(root, "./cli", "package.json")) || !existsSync(join(root, "./hoobsd", "package.json")) || !existsSync(join(root, "./gui", "package.json"))) {
            console.log("workspace not initilized");
            proceed = false;
        }

        if (!existsSync(join(root, "./hoobsd", ".env.production"))) {
            console.log("missing hoobsd production enviornment file");
            proceed = false;
        }

        if (!existsSync(join(root, "./gui", ".env.production"))) {
            console.log("missing hoobs gui production enviornment file");
            proceed = false;
        }

        if (proceed) {
            prompt([{
                type: "string",
                name: "version",
                default: pjson.version,
                message: "Enter the desired version",
                validate: (value) => {
                    if (!Semver.valid(value)) return "invalid version";

                    return true;
                },
            }]).then((result) => {
                pjson.version = result.version;
    
                writeFileSync(join(root, "package.json"), JSON.stringify(pjson, null, 4));

                const working = {
                    cli: JSON.parse(readFileSync(join(root, "./cli", "package.json")).toString()),
                    hoobsd: JSON.parse(readFileSync(join(root, "./hoobsd", "package.json")).toString()),
                    gui: JSON.parse(readFileSync(join(root, "./gui", "package.json")).toString()),
                }

                console.log("building hoobs cli");
                execTrySync(working.cli.scripts.build, { cwd: join(root, "./cli"), stdio: "inherit" });

                console.log("building hoobsd");
                execTrySync(working.hoobsd.scripts.build, { cwd: join(root, "./hoobsd"), stdio: "inherit" });

                console.log("building hoobs gui");
                execTrySync(working.gui.scripts.build, { cwd: join(root, "./gui"), stdio: "inherit" });

                console.log("building bundle");

                if (existsSync(join(root, "dist"))) execTrySync(`rm -fR ${join(root, "dist")}`, { cwd: root, stdio: "inherit" })

                mkdirSync(join(root, "dist"));
                mkdirSync(join(root, "dist/DEBIAN"));

                let control = "";

                control += "Package: hoobs\n";
                control += `Version: ${pjson.version}\n`;
                control += "Section: base\n";
                control += "Priority: optional\n";
                control += "Architecture: all\n";
                control += "Depends: hoobs-cli (>= 4.0.0), hoobsd (>= 4.0.0), hoobs-gui (>= 4.0.0)\n";
                control += "Maintainer: HOOBS Maintainers <info@hoobs.org>\n";
                control += "Homepage: https://hoobs.org\n";
                control += "Description: Build your Smart Home with HOOBS. Connect over 2,000 Accessories to your favorite Ecosystem.\n";

                writeFileSync(join(root, "dist/DEBIAN/control"), control);

                execTrySync(`cp ${join(root, "image/scripts", "prerm")} ${join(root, "dist/DEBIAN", "prerm")}`, { cwd: root, stdio: "inherit" });
                execTrySync(`cp ${join(root, "image/scripts", "postrm")} ${join(root, "dist/DEBIAN", "postrm")}`, { cwd: root, stdio: "inherit" });
                execTrySync(`cp ${join(root, "image/scripts", "postinst")} ${join(root, "dist/DEBIAN", "postinst")}`, { cwd: root, stdio: "inherit" });

                execTrySync(`chmod 755 ${join(root, "dist/DEBIAN", "prerm")}`, { cwd: root, stdio: "inherit" });
                execTrySync(`chmod 755 ${join(root, "dist/DEBIAN", "postrm")}`, { cwd: root, stdio: "inherit" });
                execTrySync(`chmod 755 ${join(root, "dist/DEBIAN", "postinst")}`, { cwd: root, stdio: "inherit" });
                execTrySync("dpkg-deb --build dist", { cwd: root, stdio: "inherit" });

                if (existsSync(join(root, "builds", `hoobs-v${pjson.version}.deb`))) unlinkSync(join(root, "builds", `hoobs-v${pjson.version}.deb`));

                execTrySync(`mv ${join(root, "dist.deb")} ${join(root, "builds", `hoobs-v${pjson.version}.deb`)}`, { cwd: root, stdio: "inherit" });
                execTrySync(`dpkg-sig --sign builder ${join(root, "builds", `hoobs-v${pjson.version}.deb`)}`, { cwd: root, stdio: "inherit" });

                if (existsSync(join(root, "dist"))) execTrySync(`rm -fR ${join(root, "dist")}`, { cwd: root, stdio: "inherit" })

                console.log("done");
            });
        }
    });

Program.command("publish [action]")
    .description("publish builds to repository")
    .action((action) => {
        let proceed = true;

        if (action === "package" || action === "image") {
            const sshpass = execTrySync("command -v sshpass").toString().replace(/\n/g, "").trim();

            if (!sshpass || sshpass === "") {
                console.log("sshpass is not installed");
                proceed = false;
            }

            if (!existsSync(join(root, "./cli", "package.json")) || !existsSync(join(root, "./hoobsd", "package.json")) || !existsSync(join(root, "./gui", "package.json"))) {
                console.log("workspace not initilized");
                proceed = false;
            }

            const working = {
                cli: JSON.parse(readFileSync(join(root, "./cli", "package.json")).toString()),
                hoobsd: JSON.parse(readFileSync(join(root, "./hoobsd", "package.json")).toString()),
                gui: JSON.parse(readFileSync(join(root, "./gui", "package.json")).toString()),
            }

            if (action === "image") {
                if (!existsSync(join(root, "./builds", `hoobs-v${pjson.version}.zip`)) || !existsSync(join(root, "./builds", `hoobs-box-v${pjson.version}.zip`))) {
                    console.log("please build image before publishing");
                    proceed = false;
                }
            }

            if (action === "package") {
                if (
                    !existsSync(join(root, "./builds", `hoobs-cli-v${working.cli.version}.tar.gz`))
                    || !existsSync(join(root, "./builds", `hoobs-cli-v${working.cli.version}.deb`))
                    || !existsSync(join(root, "./builds", `hoobsd-v${working.hoobsd.version}.tar.gz`))
                    || !existsSync(join(root, "./builds", `hoobsd-v${working.hoobsd.version}.deb`))
                    || !existsSync(join(root, "./builds", `hoobs-gui-v${working.gui.version}.tar.gz`))
                    || !existsSync(join(root, "./builds", `hoobs-gui-v${working.gui.version}.deb`))) {
                    console.log("please build package before publishing");
                    proceed = false;
                }
            }

            if (proceed) {
                prompt([{
                    type: "password",
                    name: "password",
                    message: "Enter the repository server password",
                }]).then((result) => {
                    if (action === "package") {
                        console.log("uploading deb packages");

                        execTrySync(`sshpass -p '${result.password}' scp ${join(root, "./builds", `hoobs-cli-v${working.cli.version}.deb`)} root@138.197.75.194:/var/www/html/debian/`, { cwd: root, stdio: "inherit" });
                        execTrySync(`sshpass -p '${result.password}' scp ${join(root, "./builds", `hoobsd-v${working.hoobsd.version}.deb`)} root@138.197.75.194:/var/www/html/debian/`, { cwd: root, stdio: "inherit" });
                        execTrySync(`sshpass -p '${result.password}' scp ${join(root, "./builds", `hoobs-gui-v${working.gui.version}.deb`)} root@138.197.75.194:/var/www/html/debian/`, { cwd: root, stdio: "inherit" });
                        execTrySync(`sshpass -p '${result.password}' scp ${join(root, "./builds", `hoobs-v${pjson.version}.deb`)} root@138.197.75.194:/var/www/html/debian/`, { cwd: root, stdio: "inherit" });

                        console.log("updating repository");

                        execTrySync(`sshpass -p '${result.password}' ssh root@138.197.75.194 'cd /var/www/html/debian && reprepro includedeb buster /var/www/html/debian/hoobs-cli-v${working.cli.version}.deb'`, { cwd: root, stdio: "inherit" });
                        execTrySync(`sshpass -p '${result.password}' ssh root@138.197.75.194 'cd /var/www/html/debian && reprepro includedeb buster /var/www/html/debian/hoobsd-v${working.hoobsd.version}.deb'`, { cwd: root, stdio: "inherit" });
                        execTrySync(`sshpass -p '${result.password}' ssh root@138.197.75.194 'cd /var/www/html/debian && reprepro includedeb buster /var/www/html/debian/hoobs-gui-v${working.gui.version}.deb'`, { cwd: root, stdio: "inherit" });
                        execTrySync(`sshpass -p '${result.password}' ssh root@138.197.75.194 'cd /var/www/html/debian && reprepro includedeb buster /var/www/html/debian/hoobs-v${pjson.version}.deb'`, { cwd: root, stdio: "inherit" });

                        console.log("uploading source files");

                        execTrySync(`sshpass -p '${result.password}' scp ${join(root, "./builds", `hoobs-cli-v${working.cli.version}.tar.gz`)} root@138.197.75.194:/var/www/html/source/`, { cwd: root, stdio: "inherit" });
                        execTrySync(`sshpass -p '${result.password}' scp ${join(root, "./builds", `hoobsd-v${working.hoobsd.version}.tar.gz`)} root@138.197.75.194:/var/www/html/source/`, { cwd: root, stdio: "inherit" });
                        execTrySync(`sshpass -p '${result.password}' scp ${join(root, "./builds", `hoobs-gui-v${working.gui.version}.tar.gz`)} root@138.197.75.194:/var/www/html/source/`, { cwd: root, stdio: "inherit" });

                        execTrySync(`sshpass -p '${result.password}' scp ${join(root, "./builds", `hoobs-setup-v${working.cli.version}.sh`)} root@138.197.75.194:/var/www/html/debian/`, { cwd: root, stdio: "inherit" });
                        execTrySync(`sshpass -p '${result.password}' ssh root@138.197.75.194 'rm -f /var/www/html/debian/setup'`, { cwd: root, stdio: "inherit" });
                        execTrySync(`sshpass -p '${result.password}' ssh root@138.197.75.194 'cp /var/www/html/debian/hoobs-setup-v${working.cli.version}.sh /var/www/html/debian/setup'`, { cwd: root, stdio: "inherit" });
                    }

                    if (action === "image") {
                        console.log("uploading images");

                        execTrySync(`sshpass -p '${result.password}' scp ${join(root, "./builds", `hoobs-v${pjson.version}.zip`)} root@138.197.75.194:/var/www/html/image/`, { cwd: root, stdio: "inherit" });
                        execTrySync(`sshpass -p '${result.password}' scp ${join(root, "./builds", `hoobs-box-v${pjson.version}.zip`)} root@138.197.75.194:/var/www/html/image/`, { cwd: root, stdio: "inherit" });

                        console.log("linking latest");

                        execTrySync(`sshpass -p '${result.password}' ssh root@138.197.75.194 'rm -f /var/www/html/image/hoobs-latest.zip'`, { cwd: root, stdio: "inherit" });
                        execTrySync(`sshpass -p '${result.password}' ssh root@138.197.75.194 'rm -f /var/www/html/image/hoobs-box-latest.zip'`, { cwd: root, stdio: "inherit" });

                        execTrySync(`sshpass -p '${result.password}' ssh root@138.197.75.194 'cp /var/www/html/image/hoobs-v${pjson.version}.zip /var/www/html/image/hoobs-latest.zip'`, { cwd: root, stdio: "inherit" });
                        execTrySync(`sshpass -p '${result.password}' ssh root@138.197.75.194 'cp /var/www/html/image/hoobs-box-v${pjson.version}.zip /var/www/html/image/hoobs-box-latest.zip'`, { cwd: root, stdio: "inherit" });
                    }

                    console.log("done");
                });
            }
        } else {
            console.log(Program.helpInformation());
        }
    });

Program.command("image")
    .description("build hoobs image")
    .action(() => {
        let proceed = true;

        const docker = execTrySync("command -v docker").toString().replace(/\n/g, "").trim();

        if (!docker || docker === "") {
            console.log("docker is not installed");
            proceed = false;
        }

        if (!existsSync(join(root, "./cli", "package.json")) || !existsSync(join(root, "./hoobsd", "package.json")) || !existsSync(join(root, "./gui", "package.json"))) {
            console.log("workspace not initilized");
            proceed = false;
        }

        const working = {
            cli: JSON.parse(readFileSync(join(root, "./cli", "package.json")).toString()),
            hoobsd: JSON.parse(readFileSync(join(root, "./hoobsd", "package.json")).toString()),
            gui: JSON.parse(readFileSync(join(root, "./gui", "package.json")).toString()),
            connect: JSON.parse(readFileSync(join(root, "./connect", "package.json")).toString()),
        }

        if (
            !existsSync(join(root, "./builds", `hoobs-cli-v${working.cli.version}.tar.gz`))
         || !existsSync(join(root, "./builds", `hoobs-cli-v${working.cli.version}.deb`))
         || !existsSync(join(root, "./builds", `hoobsd-v${working.hoobsd.version}.tar.gz`))
         || !existsSync(join(root, "./builds", `hoobsd-v${working.hoobsd.version}.deb`))
         || !existsSync(join(root, "./builds", `hoobs-gui-v${working.gui.version}.tar.gz`))
         || !existsSync(join(root, "./builds", `hoobs-gui-v${working.gui.version}.deb`))) {
            console.log("please build package before building image");
            proceed = false;
        }

        if (proceed) {
            prompt([{
                type: "string",
                name: "node",
                default: "14",
                message: "Select node major version",
                validate: (value) => {
                    if (Number.isNaN(parseInt(value, 10))) return "invalid version";

                    return true;
                },
            }]).then((result) => {
                execTrySync("sudo docker rm -v hoobs-image", { cwd: join(root, "image"), stdio: "ignore" });

                if (existsSync(join(root, "hoobs"))) rmSync(join(root, "image/hoobs.conf"));

                console.log("building hoobs connect");
                execTrySync(working.connect.scripts.build, { cwd: join(root, "./connect"), stdio: "inherit" });

                console.log("building image");

                if (!existsSync(join(root, "./image/stage3/01-wifi-connect/files"))) mkdirSync(join(root, "./image/stage3/01-wifi-connect/files"));

                execTrySync(`cp ${join(root, "./builds", `hoobs-connect-v${working.connect.version}.tar.gz`)} ${join(root, "./image/stage3/01-wifi-connect/files", "hoobs-connect.tar.gz")}`, { cwd: root, stdio: "inherit" });

                let variables = "";

                variables += "IMG_NAME=\"HOOBS\"\n";
                variables += `IMG_FILENAME="hoobs-${pjson.version}"\n`;
                variables += `ZIP_FILENAME="hoobs-${pjson.version}"\n`;
                variables += `NODE_RELEASE="${result.node}"\n`;
                variables += "WIFI_SSID=HOOBS\n";
                variables += "LOCALE_DEFAULT=\"en_US.UTF-8\"\n";
                variables += "KEYBOARD_KEYMAP=\"us\"\n";
                variables += "KEYBOARD_LAYOUT=\"English (US)\"\n";
                variables += "TIMEZONE_DEFAULT=\"America/Denver\"\n";
                variables += "TARGET_HOSTNAME=hoobs\n";
                variables += "FIRST_USER_NAME=hoobs\n";
                variables += "FIRST_USER_PASS=hoobsadmin\n";
                variables += "ENABLE_SSH=1\n";
                variables += "STAGE_LIST=\"stage0 stage1 stage2 stage3 stage4 stage5\"\n";

                writeFileSync(join(root, "image/hoobs.conf"), variables);

                execTrySync(`${join(root, "image/container")} -c ${join(root, "image/hoobs.conf")}`, { cwd: join(root, "image"), stdio: "inherit" });

                execTrySync(`sudo chown ${user.uid}:${user.gid} ${join(root, "image/deploy", `hoobs-${pjson.version}.zip`)}`, { cwd: join(root, "image"), stdio: "inherit" });
                execTrySync(`sudo chown ${user.uid}:${user.gid} ${join(root, "image/deploy", `hoobs-${pjson.version}-box.zip`)}`, { cwd: join(root, "image"), stdio: "inherit" });
                execTrySync(`sudo chown ${user.uid}:${user.gid} ${join(root, "image/deploy", `hoobs-${pjson.version}.info`)}`, { cwd: join(root, "image"), stdio: "inherit" });
                execTrySync(`sudo chown ${user.uid}:${user.gid} ${join(root, "image/deploy", `hoobs-${pjson.version}-box.info`)}`, { cwd: join(root, "image"), stdio: "inherit" });

                if (existsSync(join(root, "./builds", `hoobs-v${pjson.version}.zip`))) unlinkSync(join(root, "./builds", `hoobs-v${pjson.version}.zip`))
                if (existsSync(join(root, "./builds", `hoobs-box-v${pjson.version}.zip`))) unlinkSync(join(root, "./builds", `hoobs-box-v${pjson.version}.zip`))
                if (existsSync(join(root, "./builds", `hoobs-v${pjson.version}.info`))) unlinkSync(join(root, "./builds", `hoobs-v${pjson.version}.info`))
                if (existsSync(join(root, "./builds", `hoobs-box-v${pjson.version}.info`))) unlinkSync(join(root, "./builds", `hoobs-box-v${pjson.version}.info`))

                execTrySync(`sudo mv ${join(root, "image/deploy", `hoobs-${pjson.version}.zip`)} ${join(root, "./builds", `hoobs-v${pjson.version}.zip`)}`, { cwd: root, stdio: "inherit" });
                execTrySync(`sudo mv ${join(root, "image/deploy", `hoobs-${pjson.version}-box.zip`)} ${join(root, "./builds", `hoobs-box-v${pjson.version}.zip`)}`, { cwd: root, stdio: "inherit" });
                execTrySync(`sudo mv ${join(root, "image/deploy", `hoobs-${pjson.version}.info`)} ${join(root, "./builds", `hoobs-v${pjson.version}.info`)}`, { cwd: root, stdio: "inherit" });
                execTrySync(`sudo mv ${join(root, "image/deploy", `hoobs-${pjson.version}-box.info`)} ${join(root, "./builds", `hoobs-box-v${pjson.version}.info`)}`, { cwd: root, stdio: "inherit" });

                if (existsSync(join(root, "image/deploy"))) execTrySync(`sudo rm -fR ${join(root, "image/deploy")}`, { cwd: root, stdio: "inherit" });

                console.log("done");
            });
        }
    });

Program.command("volume [action]")
    .description("build hoobs image")
    .action((action) => {
        let proceed = true;

        const docker = execTrySync("command -v docker").toString().replace(/\n/g, "").trim();

        switch (action) {
            case "create":
                if (!docker || docker === "") {
                    console.log("docker is not installed");
                    proceed = false;
                }

                if (proceed) {
                    console.log("creating build volumes");

                    execTrySync("sudo docker rm -v hoobs-image", { cwd: join(root, "image"), stdio: "ignore" });
                    execTrySync("sudo docker volume create hoobs", { cwd: join(root, "image"), stdio: "inherit" });

                    console.log("done");
                }

                break;

            case "remove":
                if (!docker || docker === "") {
                    console.log("docker is not installed");
                    proceed = false;
                }

                if (proceed) {
                    console.log("removing build volumes");

                    execTrySync("sudo docker rm -v hoobs-image", { cwd: join(root, "image"), stdio: "ignore" });
                    execTrySync("sudo docker volume rm hoobs", { cwd: join(root, "image"), stdio: "inherit" });

                    console.log("done");
                }

                break;

            default:
                console.log(Program.helpInformation());
                break;
        }
    });

Program.parse(process.argv);
